---
title: "eQTL_Detector Report"
author: ''
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    pandoc_args: [
      "+RTS", "-K64m",
      "-RTS"
    ]
---

## QC on the sequence data


```{r QTLtools_bamstat, echo=FALSE, fig.height=4, fig.width=18, warning=FALSE}
library(readr)
library(kableExtra)

home <- getwd()
Results_bamstat <- file.path(home,"Results/bamstat")

list_bamstat <- list.files(path = Results_bamstat)

setwd(Results_bamstat)
list_bamstatII <- lapply(list_bamstat, function(x){
  read.table(file = x, 
             quote="\"", 
             comment.char="")
  })



Results_bamstat <- do.call("rbind", lapply(list_bamstatII, as.data.frame))
rownames(Results_bamstat) <- list_bamstat
colnames(Results_bamstat) <- c("Number of sequence reads",
                               "Number of mapped reads",
                               "Mapped reads annotated",
                               "Number of anotations",
                               "Number of covered annotations by at least one sequence")

knitr::kable(Results_bamstat, caption = "QC summary for each red") %>%
kable_styling(bootstrap_options = "striped", 
              font_size = 8,
              full_width = T)

par(mfrow=c(1,5),
    las = 2)

for(d in colnames(Results_bamstat)){
  barplot(Results_bamstat[,d],
          main = d,
          col = 116546555)
}

```



```{r echo=FALSE, fig.height=4, fig.width=16, message=FALSE, warning=FALSE}

par (las=2)
barplt1 <- Results_bamstat[,1:3]
barplt1 <- barplt1[order(barplt1$`Number of sequence reads`),]
barplot(as.matrix(t(barplt1)), col =c(1,2,3),xaxt = "n",
        sub = "Samples")
legend("topleft",
c("Number of sequence reads","Number of mapped reads", "Mapped reads annotated"),
fill =c(3,2,1))

```


```{r echo=FALSE, fig.height=4.5, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}


home <- getwd()
Results_bamstat <- file.path(home,"Results/bamstat")

list_bamstat <- list.files(path = Results_bamstat)

setwd(Results_bamstat)
list_bamstatII <- lapply(list_bamstat, function(x){
  read.table(file = x, 
             quote="\"", 
             comment.char="")
  })



Results_bamstat <- do.call("rbind", lapply(list_bamstatII, as.data.frame))
rownames(Results_bamstat) <- list_bamstat
colnames(Results_bamstat) <- c("Number of sequence reads",
                               "Number of mapped reads",
                               "Mapped reads annotated",
                               "Number of anotations",
                               "Number of covered annotations by at least one sequence")


par(mfrow=c(1,2))

plot(Results_bamstat$`Number of sequence reads`~Results_bamstat$`Number of mapped reads`,
     ylab = "Number of sequence reads" ,
     xlab = "Number of mapped reads" ,
     col ="red")
abline(lm(Results_bamstat$`Number of sequence reads`~Results_bamstat$`Number of mapped reads`),
        col = "blue",
        lty = 2)

plot(Results_bamstat$`Number of mapped reads`~ Results_bamstat$`Mapped reads annotated`,
     ylab = "Number of mapped reads" ,
     xlab = "Mapped reads annotated" ,
     col ="blue")
abline(lm(Results_bamstat$`Number of mapped reads`~ Results_bamstat$`Mapped reads annotated`),
        col = "red",
        lty = 2)
```


## Matching data.


```{r mbv, echo=FALSE, fig.height=4, fig.width=20, message=FALSE, warning=FALSE, paged.print=FALSE}
library(readr)
library(tidyverse)
library(gghighlight)
library(readr)


home <- getwd()
Results_mbv <- file.path(home,"Results/mbv")
# We make a list of mbv files for 
list_mbv <- list.files(path = Results_mbv)

setwd(Results_mbv)

par(mfrow=c(1,4))

for (d in list_mbv) {
  mbv  <- read_table2(d)
  #Fields
  x_mbv <- c(mbv$n_het_consistent/mbv$n_het_covered)
  y_mbv <- c(mbv$n_hom_consistent/mbv$n_hom_covered)
  Sample_id <- c(mbv$SampleID)
  ggdata <- data.frame(cbind(x_mbv,y_mbv))
  row.names(ggdata) <- Sample_id
  colnames(ggdata) <- c("Concordance at het","Concordance at hom")
  #Get the ggplot 
  plot(ggdata$`Concordance at hom`,ggdata$`Concordance at het`,
       xlab ="Concordance at het" ,
       ylab ="Concordance at hom" ,
       col ="blue",
       main=d,
       cex.main = 1.2,
       cex.axis = 1,
       pch = "o",
       ylim = c(0,1),
       xlim = c(0,1))
}


```

## Quantification

```{r quan, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}

library(readr)
library(kableExtra)

home <- getwd()

Results_quan <- file.path(home,"Bed-Seq")

setwd(Results_quan)

RPKM_all_bed <- read_table2("RPKM_all_sorted.bed.gz")

length_samples <- length(RPKM_all_bed[1,])
length_samples <- length_samples-7

par(mfrow = c(2,1))

boxplot(RPKM_all_bed[,7:length_samples],
        xlab = "Samples",
        main = "Boxplot of RPKM on non-standarized samples")

boxplot(-log10(RPKM_all_bed[,7:length_samples]),
        xlab = "Samples",
        main = "Boxplot of - log_10 of  RPKM")

```

## PCA on Genotypes

```{r echo=FALSE, fig.height=4, fig.width=16, message=FALSE, warning=FALSE}

library(knitr)
library(readr)

############# Biplot

home <- getwd()
Results_pca<- file.path(home,"Results/pca")
setwd(Results_pca)

Genotypes_pca <- read_table2("Genotypes_pca.txt.pca")
PCA_geno <- Genotypes_pca[,-1]
PCA_geno <- t(PCA_geno)
PCA_geno <- data.frame(PCA_geno)


par(mfrow=c(1,3))

plot(PCA_geno$X2~PCA_geno$X1,
     frame = F,
     col = "red",
     pch = "o",
     xlab = "PC1",
     ylab = "PC2",
     main = "PCA on variants")
abline(v=0,h=0, lty = 2, col = "blue")
text(PCA_geno$X1,PCA_geno$X2, row.names(PCA_geno), cex=0.6, pos=4, col="red") 


############# Prop Var

Genotypes_pca_stat <- read_table2("Genotypes_pca.txt.pca_stats", 
                                  col_names = FALSE)

pca_geno_stat <- as.matrix(Genotypes_pca_stat[,-1])

pca_geno_stat <- t(pca_geno_stat)

prop_var <- pca_geno_stat[,2]

l = length(prop_var)

prop_var <- prop_var[-l]

plot(prop_var, type = "o",
     frame = F,
     col = "blue",
     xlab = "Principal component")


############# scree plot

pca_geno_stat <- as.matrix(Genotypes_pca_stat[,-1])

pca_geno_stat <- t(pca_geno_stat)

cumm_comp <- pca_geno_stat[,3]

l = length(cumm_comp )

cumm_comp  <- cumm_comp [-l]

plot(cumm_comp, type = "o",
     frame = F,
     col = "darkgreen",
     xlab = "Principal component")



```

## PCA on gene expression


```{r echo=FALSE, fig.height=4, fig.width=16, message=FALSE, warning=FALSE}

library(knitr)
library(readr)

############# Biplot

home <- getwd()
Results_pca<- file.path(home,"Results/pca")
setwd(Results_pca)

Genotypes_pca <- read_table2("pca.Exp.txt.pca")
PCA_geno <- Genotypes_pca[,-1]
PCA_geno <- t(PCA_geno)
PCA_geno <- data.frame(PCA_geno)


par(mfrow=c(1,3))

plot(PCA_geno$X2~PCA_geno$X1,
     frame = F,
     col = "red",
     pch = "o",
     xlab = "PC1",
     ylab = "PC2",
     main = "PCA on gene expression")
abline(v=0,h=0, lty = 2, col = "blue")
text(PCA_geno$X1,PCA_geno$X2, row.names(PCA_geno), cex=0.6, pos=4, col="red") 




############# Prop Var

Genotypes_pca_stat <- read_table2("pca.Exp.txt.pca_stats", 
                                  col_names = FALSE)

pca_geno_stat <- as.matrix(Genotypes_pca_stat[,-1])

pca_geno_stat <- t(pca_geno_stat)

prop_var <- pca_geno_stat[,2]

l = length(prop_var)

prop_var <- prop_var[-l]

plot(prop_var, type = "o",
     frame = F,
     col = "blue",
     xlab = "Principal component")


############# scree plot

pca_geno_stat <- as.matrix(Genotypes_pca_stat[,-1])

pca_geno_stat <- t(pca_geno_stat)

cumm_comp <- pca_geno_stat[,3]

l = length(cumm_comp )

cumm_comp  <- cumm_comp [-l]

plot(cumm_comp, type = "o",
     frame = F,
     col = "darkgreen",
     xlab = "Principal component")


```

## Cis Nominal

```{r echo=FALSE, fig.height=5, fig.width=16, message=FALSE, warning=FALSE}

library(knitr)
library(readr)
library(kableExtra)
home <- getwd()
Results_pca<- file.path(home,"Results/cis_nominal")

cis_nominals <- read_table2("Results/cis_nominal/nominals.txt", 
    col_names = FALSE)

colnames_cis <- c("phenotype ID",
                  "chromosome ID of the phenotype",
                  "start position of the phenotype",
                  "end position of the phenotype",
                  "strand orientation of the phenotype",
                  "total number of variants tested in cis",
                  "distance between the phenotype and the tested variant",
                  "ID",
                  "chromosome ID of the variant",
                  "start position of the variant",
                  "end position of the variant",
                  "nominal P-value",
                  "regression slope",
                  "flag equal to 1 is the variant is the top variant in cis")

colnames(cis_nominals) <- colnames_cis


subset_cis_nominal <- subset(cis_nominals, cis_nominals$`flag equal to 1 is the variant is the top variant in cis` == "1")

par(mfrow = c(1,3))

o <- -log10(sort(cis_nominals$`nominal P-value`, decreasing = FALSE))
e <- -log10(1:length(o)/length(o))
plot(e, o, pch = 19, cex = 1,
     xlab = expression(Expected~~-log[10](italic(p))),
     ylab = expression(Observed~~-log[10](italic(p))),
     xlim = c(0, max(e)), ylim = c(0,max(o)))
lines(e, e, col = "red")
  
hist(-log10(cis_nominals$`nominal P-value`),
     frame = F,
     xlab = "-log10 nominal P-value",
     sub = "",
     main = "Distribution of the nominal p-values",
     col = "blue",
     breaks = 50)

hist(-log10(subset_cis_nominal$`nominal P-value`),
     frame = F,
     xlab = "-log10 nominal P-value",
     sub = "",
     main = "Distribution of the nominal p-values for the cis hits ",
     col = "red",
     breaks = 50)


subset_cis <- subset(cis_nominals, cis_nominals$`flag equal to 1 is the variant is the top variant in cis` ==1)

knitr::kable(subset_cis[1:20,]) %>%
kable_styling(bootstrap_options = "striped", 
              font_size = 7,
              full_width = T,
              fixed_thead = T)


```

### FDR Correction on nominal p-values

```{r echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE}

library(qvalue)

FDR_cis_nomial <- qvalue(cis_nominals$`nominal P-value`,pi0 = 1)

plot(FDR_cis_nomial)

```

```{bash}
#mv /home/rstudio/Bed-Seq/Genotypes.vcf /home/rstudio/Genotypes.vcf
#mv /home/rstudio/Bed-Seq/genotypes.chr22.vcf.gz /home/rstudio/genotypes.chr22.vcf.gz
```


```{r echo=FALSE, fig.height=6, fig.width=18, message=FALSE, warning=FALSE}


library(vcfR)
library(knitr)
library(readr)

cis_nominal_top <- subset(cis_nominals, cis_nominals$`flag equal to 1 is the variant is the top variant in cis` ==1)
cis_nominal_top10 <- cis_nominal_top [order(cis_nominal_top$`nominal P-value`),] 
cis_nominal_top10 <- cis_nominal_top10[1:10,]

vcf <- read.vcfR("Genotypes.vcf", verbose = FALSE )
vcf<- data.frame(cbind(vcf@fix,vcf@gt))
rownames(vcf) <- vcf$ID
vcf_top10_cis_nomial <- vcf[cis_nominal_top10$ID,]

rownames(RPKM_all_bed) <- RPKM_all_bed$gene
RPKM_top10_cis_nomial <- RPKM_all_bed[cis_nominal_top10$`phenotype ID`,]
rownames(RPKM_top10_cis_nomial) <- RPKM_top10_cis_nomial$gene 

merge1 <- (merge(cis_nominal_top10, vcf_top10_cis_nomial, by = 'ID'))
merge1 <- merge1[,-(3:21)]
rownames(merge1) <- merge1$`phenotype ID`
merge1 <- merge1[,-(1:3)]

par(mfrow = c (2,5))

for (a in RPKM_top10_cis_nomial$gene) {
  Expression_value <- RPKM_top10_cis_nomial[a,]
  Expression_value <- t(as.matrix(Expression_value[,-(1:6)]))
  Genotype <- as.matrix(t(merge1[a,]))
  boxplot(Expression_value[1:39]~Genotype[1:39],
          main = a,
          xlab = "Genotype",
          ylab = "Expression Values")
  stripchart(Expression_value[1:39]~Genotype[1:39], vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
}


```

### Cis with Dummy Data

```{bash}
#wget http://jungle.unige.ch/QTLtools_examples/genes.50percent.chr22.bed.gz
```

```{r}
library(readr)
RPKM_all_bed_d <- read_table2("genes.50percent.chr22.bed.gz")

```


```{r echo=FALSE, fig.height=4, fig.width=18, message=FALSE, warning=FALSE}

library(vcfR)
library(knitr)
library(readr)

cis_nominal_top <- subset(cis_nominals, cis_nominals$`flag equal to 1 is the variant is the top variant in cis` ==1)
cis_nominal_top10 <- cis_nominal_top [order(cis_nominal_top$`nominal P-value`),] 
cis_nominal_top10 <- cis_nominal_top10[1:20,]

vcf <- read.vcfR("genotypes.chr22.vcf.gz", verbose = FALSE )
vcf<- data.frame(cbind(vcf@fix,vcf@gt))
rownames(vcf) <- vcf$ID
vcf_top10_cis_nomial <- vcf[cis_nominal_top10$ID,]
vcf_top10_cis_nomial <- vcf_top10_cis_nomial[!duplicated(vcf_top10_cis_nomial$ID),]
##We import the RPKM_d

rownames(RPKM_all_bed_d) <- RPKM_all_bed_d$gene
RPKM_top10_cis_nomial <- RPKM_all_bed_d[cis_nominal_top10$`phenotype ID`,]
rownames(RPKM_top10_cis_nomial) <- RPKM_top10_cis_nomial$gene 

merge1 <- (merge(cis_nominal_top10, vcf_top10_cis_nomial, by = 'ID'))
merge1 <- merge1[,-(3:21)]

merge2 <- (merge(merge1, RPKM_top10_cis_nomial, 
                 by.x = "phenotype ID" , 
                 by.y ='gene',
                 all.y = F))
merge2_Genes_SNPs <-  c(paste(merge2$`phenotype ID`,merge2$ID))
rownames(merge2) <- merge2_Genes_SNPs
merge2 <- merge2[,-(1:3)]


par(mfrow=c(1,4))

for (a in merge2_Genes_SNPs) {
  sample_number <- (ncol(RPKM_all_bed_d)-6)
  box1 <- t(merge2[a,])
  Genotype <- box1[c(1:sample_number),]
  Genotype <- as.data.frame(Genotype)
  Genotype$Genotype[Genotype$Genotype == "0|1"] <- "1|0"
  l1 <- length(box1)
  l2 <- (l1- sample_number)+1
  Expression_value <- box1[l2:l1,]
  

  boxplot(as.numeric(Expression_value)~as.matrix(Genotype),
          main = a,
          xlab = "Genotype",
          ylab = "Expression Values",
          col = 0)
  stripchart(Expression_value~as.matrix(Genotype), vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
}


```

### Boxplot of the expression with the FDR correction

```{r echo=FALSE, fig.height=4, fig.width=18, message=FALSE, warning=FALSE}

library(vcfR)
library(knitr)
library(readr)

cis_nominals$`nominal P-value` <-  FDR_cis_nomial[["qvalues"]]
cis_nominal_top10 <- subset(cis_nominals, cis_nominals$`flag equal to 1 is the variant is the top variant in cis` ==1)

cis_nominal_top10 <- cis_nominal_top10[order(cis_nominal_top10$`nominal P-value`),] 

cis_nominal_top10 <- cis_nominal_top10[1:10,]

vcf <- read.vcfR("Genotypes.vcf", verbose = FALSE )
vcf<- data.frame(cbind(vcf@fix,vcf@gt))
rownames(vcf) <- vcf$ID
vcf_top10_cis_nomial <- vcf[cis_nominal_top10$ID,]

rownames(RPKM_all_bed) <- RPKM_all_bed$gene
RPKM_top10_cis_nomial <- RPKM_all_bed[cis_nominal_top10$`phenotype ID`,]
rownames(RPKM_top10_cis_nomial) <- RPKM_top10_cis_nomial$gene

merge1 <- (merge(cis_nominal_top10, vcf_top10_cis_nomial, by = 'ID'))
merge1 <- merge1[,-(3:21)]

merge2 <- (merge(merge1, RPKM_top10_cis_nomial, 
                 by.x = "phenotype ID" , 
                 by.y ='gene',
                 all.y = F))
merge2_Genes_SNPs <-  c(paste(merge2$`phenotype ID`,merge2$ID))
rownames(merge2) <- merge2_Genes_SNPs
merge2 <- merge2[,-(1:3)]


par(mfrow=c(1,4))

for (a in merge2_Genes_SNPs) {
  sample_number <- (ncol(RPKM_all_bed)-6)
  box1 <- t(merge2[a,])
  Genotype <- box1[c(1:sample_number),]
  Genotype <- as.data.frame(Genotype)
  Genotype$Genotype[Genotype$Genotype == "0|1"] <- "1|0"
  l1 <- length(box1)
  l2 <- (l1- sample_number)+1
  Expression_value <- box1[l2:l1,]
  

  boxplot(as.numeric(Expression_value)~as.matrix(Genotype),
          main = a,
          xlab = "Genotype",
          ylab = "Expression Values",
          col = 0)
  stripchart(Expression_value~as.matrix(Genotype), vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
}


```

#### Dummy Data

```{r echo=FALSE, fig.height=4, fig.width=18, message=FALSE, warning=FALSE}

library(vcfR)
library(knitr)
library(readr)

cis_nominals$`nominal P-value` <-  FDR_cis_nomial[["qvalues"]]

cis_nominal_top <- subset(cis_nominals, cis_nominals$`flag equal to 1 is the variant is the top variant in cis` ==1)
cis_nominal_top10 <- cis_nominal_top [order(cis_nominal_top$`nominal P-value`),] 
cis_nominal_top10 <- cis_nominal_top10[1:20,]

vcf <- read.vcfR("genotypes.chr22.vcf.gz", verbose = FALSE )
vcf<- data.frame(cbind(vcf@fix,vcf@gt))
rownames(vcf) <- vcf$ID
vcf_top10_cis_nomial <- vcf[cis_nominal_top10$ID,]

vcf_top10_cis_nomial <- vcf_top10_cis_nomial[!duplicated(vcf_top10_cis_nomial$ID),]


##We import the RPKM_d

rownames(RPKM_all_bed_d) <- RPKM_all_bed_d$gene
RPKM_top10_cis_nomial <- RPKM_all_bed_d[cis_nominal_top10$`phenotype ID`,]
rownames(RPKM_top10_cis_nomial) <- RPKM_top10_cis_nomial$gene 

merge1 <- (merge(cis_nominal_top10, vcf_top10_cis_nomial, by = 'ID'))
merge1 <- merge1[,-(3:21)]

merge2 <- (merge(merge1, RPKM_top10_cis_nomial, 
                 by.x = "phenotype ID" , 
                 by.y ='gene',
                 all.y = F))
merge2_Genes_SNPs <-  c(paste(merge2$`phenotype ID`,merge2$ID))
rownames(merge2) <- merge2_Genes_SNPs
merge2 <- merge2[,-(1:3)]


par(mfrow=c(1,4))

for (a in merge2_Genes_SNPs) {
  sample_number <- (ncol(RPKM_all_bed_d)-6)
  box1 <- t(merge2[a,])
  Genotype <- box1[c(1:sample_number),]
  Genotype <- as.data.frame(Genotype)
  Genotype$Genotype[Genotype$Genotype == "0|1"] <- "1|0"
  l1 <- length(box1)
  l2 <- (l1- sample_number)+1
  Expression_value <- box1[l2:l1,]
  

  boxplot(as.numeric(Expression_value)~as.matrix(Genotype),
          main = a,
          xlab = "Genotype",
          ylab = "Expression Values",
          col = 0)
  stripchart(Expression_value~as.matrix(Genotype), vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
}


```

## Cis Permutations Pass

```{r echo=FALSE, fig.height=4.5, fig.width=18, message=FALSE, warning=FALSE}

library(knitr)
library(readr)
home <- getwd()
Results_Cis_Permutations<- file.path(home,"Results/cis_permutation")
setwd(Results_Cis_Permutations)

cis_permutation <- read_table2("permutation.txt", 
    col_names = FALSE)


colnames_cis_permutation <- c("phenotype ID",
                              "chromosome ID of the phenotype",
                              "start position of the phenotype",
                              "end position of the phenotype",
                              "strand orientation of the phenotype",
                              "total number of variants tested in cis",
                              "distance between the phenotype and the tested variant",
                              "ID",
                              "chromosome ID of the top variant",
                              "start position of the top variant",
                              "end position of the top variant",
                              "number of degrees of freedom used to compute the P-values",
                              "Dummy",
                              "first parameter value of the fitted beta distribution",
                              "second parameter value of the fitted beta distribution",
                              "P-value of association between the phenotype and the top variant in cis",
                              "regression slope",
                              "empirircal P-value",
                              "beta distribution P-value")


colnames(cis_permutation) <- colnames_cis_permutation

par(mfrow = c(1,4))

a <- as.matrix((cis_permutation[,19]))
b <- as.matrix((cis_permutation[,18]))

plot(a,b,
     frame = F,
     fill = T,
     xlab = "Direct method",
     ylab = "Beta approximation")
abline(lm(a~b),
       col ="red")


hist(-log10(cis_permutation$`empirircal P-value`),
     frame = F,
     xlab = "nominal P-value",
     sub = "",
     main = "Distribution of the empirical P-value",
     col = "blue")

hist(-log10(cis_permutation$`beta distribution P-value`),
     frame = F,
     xlab = "nominal P-value",
     sub = "",
     main = "Distribution of the beta distribution P-value",
     col = "red")


library(qvalue)

d<- read_table2("permutation.txt", 
    col_names = FALSE)

d=d[!is.na(d$X19),]

d$qval=qvalue(d$X19)$qvalue
hist(d$qval, col = "green")

cis_permutation_FDR <- d

colnames(cis_permutation_FDR) <- c("phenotype ID",
                                   "chromosome ID of the phenotype",
                                   "start position of the phenotype",
                                   "end position of the phenotype",
                                   "strand orientation of the phenotype",
                                   "total number of variants tested in cis",
                                   "distance between the phenotype and the tested variant",
                                   "ID of the top variant",
                                   "chromosome ID of the top variant",
                                   "start position of the top variant",
                                   "end position of the top variant",
                                   "number of degrees of freedom used to compute the P-values",
                                   "Dummy",
                                   "first parameter value of the fitted beta distribution",
                                   "second parameter value of the fitted beta distribution",
                                   "P-value of association between the phenotype and the top variant in cis",
                                   "regression slope",
                                   "empirircal P-value",
                                   "beta distribution P-value",
                                   "q-value")

```


```{r echo=FALSE, fig.height=4, fig.width=12, message=FALSE, warning=FALSE}

library(knitr)
library(readr)
library(kableExtra)

par(mfrow = c(1,2))

plot(density(cis_permutation_FDR$`q-value`),
  frame = F,
  col = "blue",
  main = "PDF of the beta-dist p-value with the FDR applied")
hist(cis_permutation_FDR$`q-value`,
     main = "Histogram of the beta-dist p-value with the FDR applied",
     col = "blue")



knitr::kable(cis_permutation_FDR[order(cis_permutation_FDR$`q-value`),]) %>%
kable_styling(bootstrap_options = "striped", 
              font_size = 7,
              full_width = T,
              fixed_thead = T)

```

### Non-Dummy Data without FRD Correction

```{r echo=FALSE, fig.height=4, fig.width=18, message=FALSE, warning=FALSE}

library(vcfR)
library(knitr)
library(readr)


cis_permutation_top10 <- cis_permutation[order(cis_permutation$`beta distribution P-value`),] 
cis_permutation_top10 <- cis_permutation_top10[1:20,]

vcf <- read.vcfR("Genotypes.vcf", verbose = FALSE )
vcf<- data.frame(cbind(vcf@fix,vcf@gt))
rownames(vcf) <- vcf$ID
vcf_top10_cis_permutation <- vcf[cis_permutation_top10$ID,]
vcf_top10_cis_permutation <- vcf_top10_cis_permutation[!duplicated(vcf_top10_cis_permutation$ID),]

###
rownames(RPKM_all_bed) <- RPKM_all_bed$gene
RPKM_top10_cis_permutation <- RPKM_all_bed[cis_permutation_top10$`phenotype ID`,]

rownames(RPKM_top10_cis_permutation) <- RPKM_top10_cis_permutation$gene 

merge1 <- (merge(cis_permutation_top10, vcf_top10_cis_permutation, by = 'ID'))

merge1 <- merge1[,-(3:27)]

merge2 <- (merge(merge1, RPKM_top10_cis_permutation, 
                 by.x = "phenotype ID" , 
                 by.y ='gene',
                 all.y = F))
merge2_Genes_SNPs <-  c(paste(merge2$`phenotype ID`,merge2$ID))
rownames(merge2) <- merge2_Genes_SNPs
merge2 <- merge2[,-(1:3)]


par(mfrow=c(1,4))

for (a in merge2_Genes_SNPs) {
  sample_number <- (ncol(RPKM_all_bed)-6)
  box1 <- t(merge2[a,])
  Genotype <- box1[c(1:sample_number),]
  Genotype <- as.data.frame(Genotype)
  Genotype$Genotype[Genotype$Genotype == "0|1"] <- "1|0"
  l1 <- length(box1)
  l2 <- (l1- sample_number)+1
  Expression_value <- box1[l2:l1,]
  

  boxplot(as.numeric(Expression_value)~as.matrix(Genotype),
          main = a,
          xlab = "Genotype",
          ylab = "Expression Values",
          col = 0)
  stripchart(Expression_value~as.matrix(Genotype), vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
}


```

### Non-Dummy Data with FRD Correction

```{r echo=FALSE, fig.height=4, fig.width=18, message=FALSE, warning=FALSE}

library(vcfR)
library(knitr)
library(readr)
library(qvalue)


q_value_cis_permutation <- qvalue(cis_permutation$`beta distribution P-value`,pi0 = 1)

cis_permutation$`beta distribution P-value` <- q_value_cis_permutation[["qvalues"]]

cis_permutation_top10 <- cis_permutation[order(cis_permutation$`beta distribution P-value`),] 
cis_permutation_top10 <- cis_permutation_top10[1:20,]

vcf <- read.vcfR("Genotypes.vcf", verbose = FALSE )
vcf<- data.frame(cbind(vcf@fix,vcf@gt))
rownames(vcf) <- vcf$ID
vcf_top10_cis_permutation <- vcf[cis_permutation_top10$ID,]
vcf_top10_cis_permutation <- vcf_top10_cis_permutation[!duplicated(vcf_top10_cis_permutation$ID),]

###
rownames(RPKM_all_bed) <- RPKM_all_bed$gene
RPKM_top10_cis_permutation <- RPKM_all_bed[cis_permutation_top10$`phenotype ID`,]

rownames(RPKM_top10_cis_permutation) <- RPKM_top10_cis_permutation$gene 

merge1 <- (merge(cis_permutation_top10, vcf_top10_cis_permutation, by = 'ID'))

merge1 <- merge1[,-(3:27)]

merge2 <- (merge(merge1, RPKM_top10_cis_permutation, 
                 by.x = "phenotype ID" , 
                 by.y ='gene',
                 all.y = F))
merge2_Genes_SNPs <-  c(paste(merge2$`phenotype ID`,merge2$ID))
rownames(merge2) <- merge2_Genes_SNPs
merge2 <- merge2[,-(1:3)]


par(mfrow=c(1,4))

for (a in merge2_Genes_SNPs) {
  sample_number <- (ncol(RPKM_all_bed)-6)
  box1 <- t(merge2[a,])
  Genotype <- box1[c(1:sample_number),]
  Genotype <- as.data.frame(Genotype)
  Genotype$Genotype[Genotype$Genotype == "0|1"] <- "1|0"
  l1 <- length(box1)
  l2 <- (l1- sample_number)+1
  Expression_value <- box1[l2:l1,]
  

  boxplot(as.numeric(Expression_value)~as.matrix(Genotype),
          main = a,
          xlab = "Genotype",
          ylab = "Expression Values",
          col = 0)
  stripchart(Expression_value~as.matrix(Genotype), vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
}


```

### Dummy Data without FRD Correction



```{r echo=FALSE, fig.height=4, fig.width=18, message=FALSE, warning=FALSE}

library(vcfR)
library(knitr)
library(readr)


cis_permutation_top10 <- cis_permutation[order(cis_permutation$`beta distribution P-value`),] 
cis_permutation_top10 <- cis_permutation_top10[1:20,]

vcf <- read.vcfR("genotypes.chr22.vcf.gz", verbose = FALSE )
vcf<- data.frame(cbind(vcf@fix,vcf@gt))
rownames(vcf) <- vcf$ID
vcf_top10_cis_permutation <- vcf[cis_permutation_top10$ID,]
vcf_top10_cis_permutation <- vcf_top10_cis_permutation[!duplicated(vcf_top10_cis_permutation$ID),]

###
rownames(RPKM_all_bed_d) <- RPKM_all_bed_d$gene
RPKM_top10_cis_permutation <- RPKM_all_bed_d[cis_permutation_top10$`phenotype ID`,]

rownames(RPKM_top10_cis_permutation) <- RPKM_top10_cis_permutation$gene 

merge1 <- (merge(cis_permutation_top10, vcf_top10_cis_permutation, by = 'ID'))

merge1 <- merge1[,-(3:27)]

merge2 <- (merge(merge1, RPKM_top10_cis_permutation, 
                 by.x = "phenotype ID" , 
                 by.y ='gene',
                 all.y = F))
merge2_Genes_SNPs <-  c(paste(merge2$`phenotype ID`,merge2$ID))
rownames(merge2) <- merge2_Genes_SNPs
merge2 <- merge2[,-(1:3)]


par(mfrow=c(1,4))

for (a in merge2_Genes_SNPs) {
  sample_number <- (ncol(RPKM_all_bed_d)-6)
  box1 <- t(merge2[a,])
  Genotype <- box1[c(1:sample_number),]
  Genotype <- as.data.frame(Genotype)
  Genotype$Genotype[Genotype$Genotype == "0|1"] <- "1|0"
  l1 <- length(box1)
  l2 <- (l1- sample_number)+1
  Expression_value <- box1[l2:l1,]
  

  boxplot(as.numeric(Expression_value)~as.matrix(Genotype),
          main = a,
          xlab = "Genotype",
          ylab = "Expression Values",
          col = 0)
  stripchart(Expression_value~as.matrix(Genotype), vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
}

```


### Dummy Data without FRD Correction


```{r echo=FALSE, fig.height=4, fig.width=18, message=FALSE, warning=FALSE}

library(vcfR)
library(knitr)
library(readr)
library(qvalue)


q_value_cis_permutation <- qvalue(cis_permutation$`beta distribution P-value`,pi0 = 1)

cis_permutation$`beta distribution P-value` <- q_value_cis_permutation[["qvalues"]]

cis_permutation_top10 <- cis_permutation[order(cis_permutation$`beta distribution P-value`),] 
cis_permutation_top10 <- cis_permutation_top10[1:20,]

vcf <- read.vcfR("genotypes.chr22.vcf.gz", verbose = FALSE )
vcf<- data.frame(cbind(vcf@fix,vcf@gt))
rownames(vcf) <- vcf$ID
vcf_top10_cis_permutation <- vcf[cis_permutation_top10$ID,]
vcf_top10_cis_permutation <- vcf_top10_cis_permutation[!duplicated(vcf_top10_cis_permutation$ID),]

###
rownames(RPKM_all_bed_d) <- RPKM_all_bed_d$gene
RPKM_top10_cis_permutation <- RPKM_all_bed_d[cis_permutation_top10$`phenotype ID`,]

rownames(RPKM_top10_cis_permutation) <- RPKM_top10_cis_permutation$gene 

merge1 <- (merge(cis_permutation_top10, vcf_top10_cis_permutation, by = 'ID'))

merge1 <- merge1[,-(3:27)]

merge2 <- (merge(merge1, RPKM_top10_cis_permutation, 
                 by.x = "phenotype ID" , 
                 by.y ='gene',
                 all.y = F))
merge2_Genes_SNPs <-  c(paste(merge2$`phenotype ID`,merge2$ID))
rownames(merge2) <- merge2_Genes_SNPs
merge2 <- merge2[,-(1:3)]


par(mfrow=c(1,4))

for (a in merge2_Genes_SNPs) {
  sample_number <- (ncol(RPKM_all_bed_d)-6)
  box1 <- t(merge2[a,])
  Genotype <- box1[c(1:sample_number),]
  Genotype <- as.data.frame(Genotype)
  Genotype$Genotype[Genotype$Genotype == "1|0"] <- "0|1"
  l1 <- length(box1)
  l2 <- (l1- sample_number)+1
  Expression_value <- box1[l2:l1,]
  

  boxplot(as.numeric(Expression_value)~as.matrix(Genotype),
          main = a,
          xlab = "Genotype",
          ylab = "Expression Values",
          col = 0)
  stripchart(Expression_value~as.matrix(Genotype), vertical = TRUE, 
    method = "jitter", add = TRUE, pch = 20, col = 'blue')
}


```



## Trans nominal

```{r echo=FALSE, fig.height=4, fig.width=16, message=FALSE, warning=FALSE}

library(knitr)
library(readr)
library(qvalue)
home <- getwd()
Results_trans<- file.path(home,"Results/trans")


trans_nominal_best <- read_table2("Results/trans/trans.nominal.best.txt.gz",
                                  col_names = F)
colnames(trans_nominal_best) <- c("Phenotype ID",
                                  "Dummy",
                                  "Nominal P-value")

trans_nominal_bins <- read_table2("Results/trans/trans.nominal.bins.txt.gz",
                                  col_names = F)
colnames(trans_nominal_bins) <- c("Index",
                                  "Dummy1",
                                  "Dummy2",
                                  "Upper boundaries of the P-value bin",
                                  "Lower boundaries of the P-value",
                                  "Number of tests falling in this bin")

trans_nominal_hits <- read_table2("Results/trans/trans.nominal.hits.txt.gz",
                                  col_names = F)
colnames(trans_nominal_hits) <- c(" Phenotype ID",
                                  "Phenotype chrID",
                                  "Phenotype start",
                                  "Variant ID",
                                  "Variant chrID",
                                  "Variant position",
                                  "Nominal P-value of association",
                                  "Dummy",
                                  "Regression slope")



par(mfrow=c(1,3))

trans_nominals_FDR <- qvalue(trans_nominal_hits$`Nominal P-value of association`,pi0 = 1)


hist(as.matrix(trans_nominal_best[,3]),
     breaks = 50,
     col = "blue",
     main = "Distributions of the nominal P-values on top hits per phenotype",
     xlab = "Nominal P-value")

plot(trans_nominal_bins$`Number of tests falling in this bin`~ trans_nominal_bins$Index,
     frame = F,
     col = "red",
     xlab = "Bin index",
     ylab = "Number of tests falling in this bin",
     cex = 3,
     pch = ".")

hist(as.matrix(trans_nominal_hits[,7]),
     breaks = 30,
     col = "green",
     main = "Distributions of the nominal P-values on hits with a P-value above the specified --threshold (=1e-5)",
     xlab = "Nominal P-value")


```


```{r echo=FALSE, fig.height=8, fig.width=8, message=FALSE, warning=FALSE, paged.print=FALSE}

par(mfrow=c(2,4))

plot(trans_nominals_FDR,
     col ="blue")

```


```{r echo=FALSE}

knitr::kable(trans_nominal_hits[1:20,])%>%
kable_styling(bootstrap_options = "striped", 
              font_size = 7,
              full_width = T,
              fixed_thead = T)

```


## Trans permutatios pass


```{r echo=FALSE, fig.height=5, fig.width=16, message=FALSE, warning=FALSE}

library(knitr)
library(readr)
home <- getwd()
Results_trans<- file.path(home,"Results/trans")


trans_permutation_best <- read_table2("Results/trans/trans.permutation.best.txt.gz",
                                  col_names = F)
colnames(trans_permutation_best) <- c("Phenotype ID",
                                  "Dummy",
                                  "Nominal P-value")

trans_permutation_bins <- read_table2("Results/trans/trans.permutation.bins.txt.gz",
                                  col_names = F)
colnames(trans_permutation_bins) <- c("Index",
                                  "Dummy1",
                                  "Dummy2",
                                  "Upper boundaries of the P-value bin",
                                  "Lower boundaries of the P-value",
                                  "Number of tests falling in this bin")

trans_permutation_hits <- read_table2("Results/trans/trans.permutation.hits.txt.gz",
                                  col_names = F)
colnames(trans_permutation_hits) <- c(" Phenotype ID",
                                  "Phenotype chrID",
                                  "Phenotype start",
                                  "Variant ID",
                                  "Variant chrID",
                                  "Variant position",
                                  "Nominal P-value of association",
                                  "Dummy",
                                  "Regression slope")


```

